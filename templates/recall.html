{% extends "index.html" %}

{% block content %}

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='recall.css') }}">
</head>
<div class="container">

    <h1>{{ title }}</h1>
    <p class="fs-5">Active recall is a study method that involves actively stimulating memory during the learning
        process. It is based on the principle that actively retrieving information helps improve and
        strengthen memory. The method employed by LearnMateAI is based on supplying
        the term associated with a prompted definition, without looking at any
        material. </p>
    <div class="d-flex my-1"></div>
    <main class="main-container">
        <div class="card-container">
            <div class="card">

                <div id="placeholders-div" class="placeholder-glow">
                    <h5>
                        <span id="def-text" hidden>Definition</span>
                        <span id="text-placeholder" class="placeholder col-8" hidden>Definition</span>
                    </h5>
                </div>

                <form class="text-submit-form" action="/" method="GET" id="recall-form">
                    <div class="form-group">
                        <label for="textInput" class="form-label">Type the Answer:</label>
                        <textarea id="textInput" name="textInput" class="text-input" placeholder="Enter your text here"
                            disabled></textarea>
                    </div>
                    <p id="answer-correctness" style="color: '';"></p>
                    <button class="btn btn-primary" type="button" id="answer-btn">Check Answer</button>
                    <button class="btn btn-primary" type="submit" id="complete-btn" disabled>Complete Session</button>
                </form>

            </div>
            <div class="d-flex justify-content-center my-3">
                <div class="btn-group btn-lg" role="group" aria-label="Basic example">
                    <button class="btn btn-primary" type="button" id="restart-fresh-btn" disabled> Restart All Terms?
                    </button>
                    <button class="btn btn-primary" type="button" id="restart-missed-btn" disabled> Restart Missed Terms?
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    $(document).ready(function () {
        let currentIndex = 0;
        let terms = [];
        let missedTerms = [];
        let correctTerms = [];
        getTerms();

        // Use the /get-cards url defined in main.py to get the terms from
        // the OpenAPI database.
        function getTerms() {
            $.ajax({
                // url: '/get-cards',
                url: '/dummy-get-cards',
                type: 'POST',
                // Send the subject and subtopic to the server as JSON. The
                // variable values are set using Jinja templating from the
                // main.py file.
                data: JSON.stringify({
                    subject: "{{ subject }}",
                    subtopic: "{{ subtopic }}"
                }),
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    // $('#loadTerms-btn').prop('disabled', true);
                    $('#text-placeholder').prop('hidden', false);
                },
                // Upon sucess, update the terms variable with the
                // response, hide the glowing placeholder, and unhide
                // the definition field.
                success: function (response) {
                    terms = response;
                    $('#text-placeholder').prop('hidden', true);
                    $('#def-text').prop('hidden', false);
                    $('#textInput').prop('disabled', false);
                    $('#def-text').text(terms[currentIndex]['Definition']);
                },
                // Upon completion, set the definition text to the
                // current term's definition.
                complete: function () {
                },
                error: function () {
                    // Handle error, e.g., display a message
                    window.location.replace('/');
                    alert('Failed to fetch Active Recall terms. You are being returned to the home page. Please try again later.')
                    console.error('Failed to fetch terms.');
                }
            });
        }

        function shuffle(array) {
            let index = array.length;
            // While there remain elements to shuffle...
            while (index != 0) {
                // Pick a remaining element...
                let randomIndex = Math.floor(Math.random() * index);
                index--;
                // And swap it with the current element.
                [array[index], array[randomIndex]] = [array[randomIndex], array[index]];
            }
        }


        // Existing click event for the answer button
        $('#answer-btn').click(function () {
            submitAnswer();
        });

        // Keypress event for the textarea
        $('#textInput').keypress(function (event) {
            // Check if the pressed key is 'Enter'
            if (event.which == 13) {
                event.preventDefault(); // Prevent the default action (form submission)
                $('#answer-btn').click(); // Trigger the answer button click
            }
        });

        function submitAnswer() {
            let textInput = $('#textInput').val().trim().toLowerCase();
            if (textInput === terms[currentIndex]['Term'].toLowerCase()) {
                correctTerms.push(terms[currentIndex]);
                $('#answer-correctness').prop('style', 'color: green');
                $('#answer-correctness').text('Correct!');
            } else {
                $('#answer-correctness').prop('style', 'color: red');
                $('#answer-correctness').text('Incorrect. The correct answer is: ' + terms[currentIndex]['Term']);
                missedTerms.push(terms[currentIndex]);
            }
            currentIndex++;
            // setTimeout does not inhibit other functions from executing.
            setTimeout(function () {
                $('#recall-form')[0].reset();
                if (currentIndex < terms.length) {
                    $('#def-text').text(terms[currentIndex]['Definition']);
                    $('#answer-correctness').text('');
                } else {
                    $('#answer-correctness').text('');
                    $('#textInput').prop('disabled', true);
                    $('#def-text').text('No more terms to display.');
                    $('#answer-btn').prop('disabled', true);
                    $('#complete-btn').prop('disabled', false);
                    $('#restart-fresh-btn').prop('disabled', false);
                    $('#restart-missed-btn').prop('disabled', missedTerms.length === 0);
                }
            }, 3000);
        }

        $('#restart-fresh-btn').click(function () {
            currentIndex = 0;
            terms = missedTerms.concat(correctTerms);
            shuffle(terms);
            missedTerms = [];
            correctTerms = [];
            $('#def-text').text(terms[currentIndex]['Definition']);
            $('#textInput').prop('disabled', false);
            $('#answer-btn').prop('disabled', false);
            $('#complete-btn').prop('disabled', true);
        });

        $('#restart-missed-btn').click(function () {
            currentIndex = 0;
            terms = missedTerms;
            shuffle(terms);
            missedTerms = [];
            $('#restart-missed-btn').prop('disabled', true);
            $('#restart-fresh-btn').prop('disabled', true);
            $('#def-text').text(terms[currentIndex]['Definition']);
            $('#textInput').prop('disabled', false);
            $('#answer-btn').prop('disabled', false);
            $('#complete-btn').prop('disabled', true);
        });

    });

</script>
{% endblock %}