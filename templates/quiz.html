{% extends "index.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='quiz.css') }}">
    <style>
        body {
            color: #343a40;
        }
        .feedback-container {
            display: none;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="feedback-container">
        <p class="feedback-text"></p>
    </div>
    <div class="quiz-container">
        <div class="question-container">
            <h1 class="question-title">Loading...</h1>
            <div class="btn-container">
                <div class="btn-row">
                    <button type="button" class="btn-option-a">Option A</button>
                    <button type="button" class="btn-option-b">Option B</button>
                </div>
                <div class="btn-row">
                    <button type="button" class="btn-option-c">Option C</button>
                    <button type="button" class="btn-option-d">Option D</button>
                </div>
            </div>
            <button class="next-question-btn" type="button">Next Question</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            fetch('/generate_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subject: "{{ subject }}",
                    subtopic: "{{ subtopic }}"
                }),
            })
            .then(response => response.json())
            .then(data => {
                let questions = data.Quiz;
                let currentQuestionIndex = 0;
                let correctAnswersCount = 0;

                function displayQuestion(questionIndex) {
                    let questionData = questions[questionIndex];
                    let questionText = questionData.Question;
                    let answerOptions = questionText.split('\n').slice(1, 5); 

                    document.querySelector('.question-title').innerText = questionText.split('\n')[0]; 
                    document.querySelector('.btn-option-a').innerText = answerOptions[0].trim();
                    document.querySelector('.btn-option-b').innerText = answerOptions[1].trim();
                    document.querySelector('.btn-option-c').innerText = answerOptions[2].trim();
                    document.querySelector('.btn-option-d').innerText = answerOptions[3].trim();
                }

                function showFeedback(isCorrect, correctAnswer) {
                    document.querySelector('.feedback-text').innerText = 
                        'Answer: ' + correctAnswer + ' - ' + (isCorrect ? 'Correct!' : 'Incorrect');
                    document.querySelector('.feedback-container').style.display = 'block';
                }

                function hideFeedback() {
                    document.querySelector('.feedback-container').style.display = 'none';
                }

                displayQuestion(currentQuestionIndex);

                document.querySelectorAll('.btn-container button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        let userAnswer = e.target.innerText[0]; // 'A', 'B', 'C', or 'D'
                        let userAnswerIndex = userAnswer.charCodeAt(0) - 64; // Convert 'A' -> 1, 'B' -> 2, etc.
                        let correctAnswerIndex = parseInt(questions[currentQuestionIndex]["Answer Index"]);

                        let correctAnswer = questions[currentQuestionIndex].Answer.split(': ')[1].trim(); 
                        let isCorrect = userAnswerIndex === correctAnswerIndex;

                        if (isCorrect) {
                            correctAnswersCount++;
                        }

                        showFeedback(isCorrect, correctAnswer);
                    });
                });
                document.querySelector('.next-question-btn').addEventListener('click', () => {
                    hideFeedback();
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        displayQuestion(currentQuestionIndex);
                    } else {
                        document.querySelector('.question-title').innerText = 
                            `Quiz Completed! You answered ${correctAnswersCount} out of ${questions.length} questions correctly.`;
                        document.querySelector('.btn-container').style.display = 'none';
                        document.querySelector('.feedback-container').style.display = 'none';
                        document.querySelector('.next-question-btn').textContent = 'Finish';
                        document.querySelector('.next-question-btn').addEventListener('click', async () => {
                            // Save the quiz results to the database
                            const response = await fetch('/save_quiz_result', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    subject: "{{ subject }}",
                                    subtopic: "{{ subtopic }}",
                                    num_correct: correctAnswersCount,
                                    // The time stamp of the quiz is handled on server
                                }),
                            });
                            // GACK!!! This was a really ugly way to do this
                            // I thought that the post request would automatically
                            // redirect to quiz_results. This is a quick and
                            // dirty way to force it to do what I want it to do
                            window.location.href = '/quiz_results'
                        });
                    }
                });
            });
        });
    </script>
</body>
{% endblock %}
